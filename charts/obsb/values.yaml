# ============================================================
# Global
# ============================================================

global:
  clusterName: "obsb-dev"
  storageClass: "standard"   # Your Kind default SC (NOT local-path)

# ============================================================
# ZABBIX CONFIG
# ============================================================

zabbix:
  enabled: true

  imagePullSecrets:
    - name: dockerhub-secret

  # Global DB settings for all Zabbix components
  DB_SERVER_HOST: "obsb-postgresql"
  DB_SERVER_PORT: "5432"
  POSTGRES_USER: "zabbix"
  POSTGRES_PASSWORD: "zabbix"
  POSTGRES_DB: "zabbix"

  zabbixserver:
    replicaCount: 1
    image:
      pullPolicy: IfNotPresent
      tag: "ubuntu-6.0.0"
    DB_SERVER_HOST: "obsb-postgresql"
    DB_SERVER_PORT: "5432"
    POSTGRES_USER: "zabbix"
    POSTGRES_PASSWORD: "zabbix"
    POSTGRES_DB: "zabbix"

  server:
    replicaCount: 1
    DB_SERVER_HOST: "obsb-postgresql"
    DB_SERVER_PORT: "5432"
    POSTGRES_USER: "zabbix"
    POSTGRES_PASSWORD: "zabbix"
    POSTGRES_DB: "zabbix"
    env:
      DB_SERVER_HOST: "obsb-postgresql"
      DB_SERVER_PORT: "5432"
      POSTGRES_USER: "zabbix"
      POSTGRES_PASSWORD: "zabbix"
      POSTGRES_DB: "zabbix"

  frontend:
    service:
      type: ClusterIP
    env:
      DB_SERVER_HOST: "obsb-postgresql"
      DB_SERVER_PORT: "5432"
      POSTGRES_USER: "zabbix"
      POSTGRES_PASSWORD: "zabbix"
      POSTGRES_DB: "zabbix"
    image:
      pullPolicy: IfNotPresent
      tag: "ubuntu-6.0.0"

  zabbixweb:
    DB_SERVER_HOST: "obsb-postgresql"
    DB_SERVER_PORT: 5432
    POSTGRES_USER: "zabbix"
    POSTGRES_PASSWORD: "zabbix"
    POSTGRES_DB: "zabbix"
    image:
      pullPolicy: IfNotPresent
      tag: "ubuntu-6.0.0"

  proxy:
    enabled: true
    image:
      pullPolicy: IfNotPresent
      tag: "ubuntu-6.0.0"

  database:
    type: postgresql

  # REAL override path for PostgreSQL inside Zabbix chart
  postgresql:
    enabled: true

    image:
      registry: docker.io
      repository: bitnami/postgresql
      tag: "latest"        # keep preloaded image; pin to available version for Kind
      pullPolicy: IfNotPresent

    global:
      imagePullSecrets:
        - dockerhub-secret

    auth:
      username: zabbix
      password: zabbix
      database: zabbix

    primary:
      persistence:
        enabled: true
        storageClass: "standard"
        size: 1Gi

# ============================================================
# OPENSEARCH
# ============================================================

opensearch:
  enabled: true

  image:
    repository: opensearchproject/opensearch
    tag: "2.19.4"
    pullPolicy: IfNotPresent

  replicas: 1
  clusterName: "obsb-opensearch"

  extraEnvs:
    - name: OPENSEARCH_INITIAL_ADMIN_PASSWORD
      value: "Zx9@gZXWJwYSVvKp7!"

  sysctlInit:
    enabled: false

  persistence:
    enabled: true
    size: 5Gi
    storageClass: "standard"

  resources:
    requests:
      cpu: 200m
      memory: 512Mi
    limits:
      cpu: 500m
      memory: 1Gi

  roles:
    - master
    - ingest
    - data

  opensearchJavaOpts: "-Xms512m -Xmx512m"

# ============================================================
# OPENSEARCH DASHBOARDS
# ============================================================

dashboards:
  enabled: true

  image:
    repository: opensearchproject/opensearch-dashboards
    tag: "2.19.4"
    pullPolicy: IfNotPresent

  replicaCount: 1
  opensearchHosts: "http://obsb-opensearch:9200"

  service:
    type: ClusterIP

  resources:
    requests:
      cpu: 100m
      memory: 256Mi

# ============================================================
# LOGSTASH (with correct OpenSearch plugin)
# ============================================================

logstash:
  enabled: true

  image: "opensearchproject/logstash-oss-with-opensearch-output-plugin"
  imageTag: "7.16.3"
  imagePullPolicy: "IfNotPresent"

  replicaCount: 1

  logstashPipeline:
    logstash.conf: |
      input {
        beats {
          port => 5044
        }
      }
      output {
        opensearch {
          hosts => ["http://obsb-opensearch:9200"]
          index => "logs-%{+YYYY.MM.dd}"
        }
      }

  service:
    type: ClusterIP
    ports:
      - name: beats
        port: 5044
        targetPort: 5044

# ============================================================
# TRIVY SCANNER
# ============================================================

trivy:
  enabled: true

  image: "aquasec/trivy:latest"

  imageScanning:
    enabled: true
    schedule: "0 */6 * * *"
    imageList:
      - "nginx:latest"
      - "python:3.11-slim"
    outputDir: /results

  k8sScanning:
    enabled: true
    schedule: "0 2 * * *"
    namespaces:
      - default
      - obsb-core
    outputDir: /results

# ============================================================
# LOGGING (Fluent Bit / logshipper)
# ============================================================

logging:
  enabled: true

# ============================================================
# STACKS (EXAMPLE COMMENTED)
# ============================================================

# stacks:
#   - name: "example-app"
#     namespace: "default"
#     logs:
#       enabled: true
#     metrics:
#       enabled: true
#     security:
#       enabled: true

stacks: []

# ============================================================
# INGRESS
# ============================================================

ingress:
  enabled: false
  className: "nginx"

  dashboards:
    host: dashboards.local
    path: /

  zabbix:
    host: zabbix.local
    path: /
